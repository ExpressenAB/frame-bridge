!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define([],function(){return a.returnExportsGlobal=b()}):a.FrameBridge=b()}(this,function(){"use strict";function a(){}function b(){this.id=Math.random().toString().substr(2),this.promise=new a}function c(a,b){this.targetWindow=a,this.targetDomain=b,this.listeners=[]}function d(a,b,c){this.localAPIObject=a,this.targetWindow=b,this.targetDomain=c,this.localFunctionsInProgress={}}var e={INIT:"init",CHILD_READY:"child-ready",REQUEST_API:"request-api",API:"api",API_RECEIVED:"api-received",CALL_FUNCTION:"call-function",RETURN_VALUE:"return-value",RETURN_ERROR:"return-error"};a.prototype.success=function(a){return this.successCallback=a,this},a.prototype.error=function(a){return this.errorCallback=a,this},b.prototype.resolve=function(a){this.promise.successCallback&&this.promise.successCallback(a)},b.prototype.reject=function(a){this.promise.errorCallback&&this.promise.errorCallback(a)},c.prototype.sendEvent=function(a,b){var c={event:a};b&&(c.data=b),this.targetWindow.postMessage(JSON.stringify(c),this.targetDomain)},c.prototype.receiveEvent=function(a){if(a.origin===this.targetDomain){var b,c;try{for(b=JSON.parse(a.data),c=0;c<this.listeners.length;c++)this.listeners[c].event===b.event&&this.listeners[c].callback(b.data)}catch(d){window.console&&"function"==typeof window.console.log&&window.console.log(d)}}},c.prototype.addListener=function(a,b){this.listeners.push({event:a,callback:b})},c.prototype.removeListener=function(a,b){var c;for(c=0;c<this.listeners.length;c++)if(this.listeners[c].event===a&&this.listeners[c].callback===b)return void this.listeners.splice(c,1)},c.prototype.init=function(){function a(a){b.receiveEvent(a)}var b=this;return window.addEventListener?window.addEventListener("message",a,!1):window.attachEvent&&window.attachEvent("onmessage",a),b};var f=6e4,g=100,h=f/g;return d.prototype.invoke=function(a,c){var d=new b;return this.messageDispatcher.sendEvent(e.CALL_FUNCTION,{name:a,args:c,deferId:d.id}),this.localFunctionsInProgress[d.id]=d,d.promise},d.prototype.getInterfaceFunction=function(a){var b=this;return function(){var c=Array.prototype.splice.call(arguments,0,arguments.length);return b.invoke(a,c)}},d.prototype.setupLocalAPIRequestListener=function(){var a=this,b=function(){a.messageDispatcher.removeListener(e.API_RECEIVED,b),a.localAPIReceived=!0,a.checkInitDone()},c=function(){a.messageDispatcher.removeListener(e.REQUEST_API,c),a.messageDispatcher.addListener(e.API_RECEIVED,b),a.messageDispatcher.sendEvent(e.API,a.API)};a.messageDispatcher.addListener(e.REQUEST_API,c)},d.prototype.checkInitDone=function(){this.localAPIReceived&&this.remoteAPIObjectInterface&&this.initDoneCallback(this.remoteAPIObjectInterface)},d.prototype.setupRemoteAPIListener=function(){var a=this,b=function(c){clearTimeout(a.requestRemoteAPI),a.messageDispatcher.removeListener(e.API,b),a.setupRemoteAPIObjectInterface(c),a.setupBridge(),a.messageDispatcher.sendEvent(e.API_RECEIVED),a.checkInitDone()};a.messageDispatcher.addListener(e.API,b)},d.prototype.requestRemoteAPI=function(a){var b=this;b.messageDispatcher.sendEvent(e.REQUEST_API),h>a&&(b.waitForFrameTimeout=setTimeout(function(){b.requestRemoteAPI(++a)},g))},d.prototype.sendReturnValue=function(a,b){var c={result:a,deferId:b};this.messageDispatcher.sendEvent(e.RETURN_VALUE,c)},d.prototype.callFunctionHandler=function(b){var c=this;try{var d=c.localAPIObject[b.name].apply(c.localAPIObject,b.args);d&&d instanceof a?d.success(function(a){c.sendReturnValue(a,b.deferId)}).error(function(a){c.messageDispatcher.sendEvent(e.RETURN_ERROR,{deferId:b.deferId})}):c.sendReturnValue(d,b.deferId)}catch(f){window.console&&"function"==typeof window.console.log&&console.log(f),c.messageDispatcher.sendEvent(e.RETURN_ERROR,{deferId:b.deferId})}},d.prototype.setupBridge=function(){var a=this;a.messageDispatcher.addListener(e.CALL_FUNCTION,function(b){a.callFunctionHandler(b)}),a.messageDispatcher.addListener(e.RETURN_VALUE,function(b){var c=a.localFunctionsInProgress[b.deferId];c.resolve(b.result),delete a.localFunctionsInProgress[b.deferId]}),a.messageDispatcher.addListener(e.RETURN_ERROR,function(b){var c=a.localFunctionsInProgress[b.deferId];c.reject(),delete a.localFunctionsInProgress[b.deferId]})},d.prototype.setupRemoteAPIObjectInterface=function(a){this.remoteAPIObjectInterface={};var b;for(b=0;b<a.length;b++)this.remoteAPIObjectInterface[a[b]]=this.getInterfaceFunction(a[b])},d.prototype.extractAPIFromLocalAPIObject=function(){var a=[];for(var b in this.localAPIObject)"function"==typeof this.localAPIObject[b]&&a.push(b);this.API=a},d.prototype.init=function(a){return this.initDoneCallback=a,this.messageDispatcher=new c(this.targetWindow,this.targetDomain).init(),this.extractAPIFromLocalAPIObject(),this.setupRemoteAPIListener(),this.setupLocalAPIRequestListener(),this.requestRemoteAPI(0),this},{create:function(a,b,c){return new d(a,b,c)},defer:function(){return new b}}});